<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>25121905</title>
    <style>
        :root { --nav-height: 64px; --footer-height: var(--nav-height); }
        /* Reset */
        * { box-sizing: border-box; margin: 0; padding: 0; touch-action: manipulation; }
        html, body { 
            height: 100%; 
            width: 100%; 
            overflow: hidden; /* 防止整个页面滚动 */
            position: fixed; /* 固定整个页面，防止缩放 */
        }

        /* 顶部固定导航栏 */
        #topNav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--nav-height);
            background: transparent;
            display: flex;
            align-items: center;
            padding: 0 16px;
            z-index: 1000;
            border-bottom: none;
            /* 防止缩放影响 */
            transform: translateZ(0);
            backface-visibility: hidden;
        }
        /* 在导航底部添加一条灰色的边框，宽度为页面的 95% 并居中 */
        #topNav::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 95%;
            border-bottom: 1px solid #ccc;
            pointer-events: none;
        }
        #topNav .nav-left, #topNav .nav-center, #topNav .nav-right {
            display: flex;
            align-items: center;
        }
        #topNav .nav-left { flex: 0 0 auto; }
        #topNav .nav-center { flex: 1; justify-content: center; }
        /* title-wrap removed: title and icon are separate nav areas */
        .nav-icon-btn {
            width: 36px; height: 36px; border-radius: 6px; display: inline-flex; align-items: center; justify-content: center;
            background: #fff; border: 1px solid #ccc; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            padding: 6px;
        }
        .nav-icon-img { width: 18px; height: 18px; display: block; }
        #topNav .nav-right { flex: 0 0 auto; }
        #topNav .nav-logo { height: 40px; width: auto; display: block; }
        #topNav .nav-title { height: 44px; max-width: 100%; width: auto; display: block; }

        /* SVG 容器：可缩放和滑动的区域 */
        #svgContainer {
            position: fixed;
            top: var(--nav-height);
            bottom: var(--footer-height);
            left: 0;
            right: 0;
            overflow: auto;
            background: #ffffff;
            z-index: 1;
            /* 允许缩放和滑动 */
            touch-action: pan-x pan-y;
            -webkit-overflow-scrolling: touch;
        }
        /* SVG wrapper 用于缩放变换 */
        #svgWrapper {
            width: 100%;
            height: 100%;
            position: relative;
            transform-origin: 0 0;
            transition: transform 0.1s ease-out;
        }
        /* object 中的 svg 保持初始尺寸 */
        #svgContainer object {
            width: 100%;
            height: 100%;
            display: block;
            pointer-events: auto;
        }

        /* 页脚内的重置按钮（已移入页脚右侧） */
        #resetBtn {
            padding: 6px 12px;
            background-color: #409eff;
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            transform-origin: center center;
        }
        #resetBtn:hover { background-color: #66b1ff; }

        /* 底部固定页脚（样式与导航栏一致，高度为导航栏的一半） */
        #pageFooter {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            height: var(--footer-height);
            background: transparent;
            display: flex;
            align-items: center;
            padding: 0 16px;
            z-index: 1000;
            border-top: none;
            /* 防止缩放影响 */
            transform: translateZ(0);
            backface-visibility: hidden;
        }
        /* 在页脚顶部添加一条灰色的边框，宽度为页面的 95% 并居中 */
        #pageFooter::before {
            content: "";
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 95%;
            border-top: 1px solid #ccc;
            pointer-events: none;
        }
        #pageFooter .footer-left, #pageFooter .footer-center, #pageFooter .footer-right {
            display: flex;
            align-items: center;
        }
        #pageFooter .footer-left { flex: 0 0 240px; display:flex; align-items:center; justify-content:center; }
        .footer-copy { font-size: 12px; color: #333; }
        #pageFooter .footer-center { flex: 1; justify-content: center; }
        #pageFooter .footer-right { flex: 0 0 auto; }

        /* SVG 内的变暗/高亮类（作为备用，注入到 SVG 内也会使用） */
        .dimmed { opacity: 0.2; filter: grayscale(100%); transition: opacity .25s ease; }
        .highlighted { opacity: 1; filter: none; }

        /* 页面侧边 HTML legend（如果存在） */
        .html-legend-entry { padding:6px 10px; border:1px solid #d9d9d9; border-radius:4px; background:#fff; cursor:pointer; margin-right:6px; }
        .html-legend-entry.active { background:#409eff; color:#fff; border-color:#409eff; }

        /* 缩放控制按钮 */
        .zoom-controls {
            position: fixed;
            right: 20px;
            bottom: calc(var(--footer-height) + 20px);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .zoom-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: white;
            border: 1px solid #ccc;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            user-select: none;
            touch-action: manipulation;
        }

        /* 模态框样式（带过渡动画） */
        .modal { position: fixed; inset: 0; z-index: 2000; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 220ms ease; }
        .modal.open { opacity: 1; pointer-events: auto; }
        .modal-backdrop { position: absolute; inset: 0; background: rgba(0,0,0,0); transition: background 220ms ease; }
        .modal.open .modal-backdrop { background: rgba(0,0,0,0.5); }
        .modal-content { position: relative; z-index: 2001; background: #fff; border-radius: 8px; padding: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.25); max-width: 92%; max-height: calc(100vh - var(--nav-height) - var(--footer-height) - 40px); display: flex; align-items: center; justify-content: center; transform: translateY(-8px) scale(.98); opacity: 0; transition: transform 220ms cubic-bezier(.2,.9,.2,1), opacity 200ms ease; }
        .modal.open .modal-content { transform: translateY(0) scale(1); opacity: 1; }
        .modal-body img { max-width: 100%; max-height: 100%; display:block; }
        .modal-close { position: absolute; top: 8px; right: 8px; background: transparent; border: none; font-size: 20px; cursor: pointer; }
    </style>
</head>
<body>
    <!-- 顶部固定导航栏 -->
    <nav id="topNav" role="navigation" aria-label="主导航">
        <div class="nav-left">
            <img src="logo.png" alt="Logo" class="nav-logo" />
        </div>
        <div class="nav-center">
            <img src="mainTitle.png" alt="主标题" class="nav-title" />
        </div>
        <div class="nav-right">
            <button id="titleModalBtn" class="nav-icon-btn" aria-haspopup="dialog" aria-controls="imageModal" title="查看 artTime">
                <img src="time.svg" alt="time" class="nav-icon-img" />
            </button>
        </div>
    </nav>

    <!-- 页脚（固定在底部），重置按钮移至右侧 -->
    <footer id="pageFooter" role="contentinfo">
        <div class="footer-left"><small class="footer-copy">Copyright © Leshan HuaiRen Cyber Tech</small></div>
        <div class="footer-center"><!-- 中间预留 --></div>
        <div class="footer-right">
            <button id="resetBtn">重置</button>
        </div>
    </footer>

    <!-- SVG 容器（可缩放和滑动） -->
    <div id="svgContainer">
        <div id="svgWrapper">
            <object id="lineSvg" data="art25121903.svg" type="image/svg+xml"></object>
        </div>
    </div>

    <!-- 缩放控制按钮 -->
    <div class="zoom-controls">
        <button class="zoom-btn" id="zoomInBtn">+</button>
        <button class="zoom-btn" id="zoomOutBtn">−</button>
        <button class="zoom-btn" id="resetZoomBtn">↺</button>
    </div>

    <!-- 图片模态框（默认隐藏） -->
    <div id="imageModal" class="modal" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="imageModalTitle">
        <div class="modal-backdrop" data-close></div>
        <div class="modal-content">
            <button class="modal-close" aria-label="关闭">×</button>
            <h2 id="imageModalTitle" style="position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden;">Art Time</h2>
            <div class="modal-body">
                <img src="artTime.jpg" alt="Art Time" />
            </div>
        </div>
    </div>

    <script>
        // 全局变量：存储所有线路的映射数据
        let allLineData = {};
        // 线路JSON文件列表（删除了T1_Main.json和T4_Main.json）
        const lineJsonFiles = [
            "T1_Branch.json",
            "T1_Extension.json",
            "T1T4_Integrated.json",
            "T2_Branch.json",
            "T2_Main.json",
            "T4_Branch.json"
        ];

        // 缩放相关变量
        let scale = 1;
        let minScale = 0.5;
        let maxScale = 3;
        let lastDistance = 0;
        let isZooming = false;

        // 初始化缩放功能
        function initZoom() {
            const svgContainer = document.getElementById('svgContainer');
            const svgWrapper = document.getElementById('svgWrapper');
            const zoomInBtn = document.getElementById('zoomInBtn');
            const zoomOutBtn = document.getElementById('zoomOutBtn');
            const resetZoomBtn = document.getElementById('resetZoomBtn');

            if (!svgContainer || !svgWrapper) return;

            // 双指缩放事件处理
            svgContainer.addEventListener('touchstart', (e) => {
                if (e.touches.length === 2) {
                    e.preventDefault();
                    isZooming = true;
                    lastDistance = getDistance(e.touches[0], e.touches[1]);
                }
            });

            svgContainer.addEventListener('touchmove', (e) => {
                if (e.touches.length === 2 && isZooming) {
                    e.preventDefault();
                    const currentDistance = getDistance(e.touches[0], e.touches[1]);
                    const delta = currentDistance - lastDistance;
                    
                    // 计算新的缩放比例
                    const newScale = scale + delta * 0.01;
                    
                    // 限制缩放范围
                    if (newScale >= minScale && newScale <= maxScale) {
                        scale = newScale;
                        applyTransform();
                    }
                    
                    lastDistance = currentDistance;
                }
            });

            svgContainer.addEventListener('touchend', (e) => {
                if (e.touches.length < 2) {
                    isZooming = false;
                }
            });

            // 缩放按钮事件
            zoomInBtn.addEventListener('click', () => {
                scale = Math.min(maxScale, scale + 0.2);
                applyTransform();
            });

            zoomOutBtn.addEventListener('click', () => {
                scale = Math.max(minScale, scale - 0.2);
                applyTransform();
            });

            resetZoomBtn.addEventListener('click', () => {
                scale = 1;
                applyTransform();
                // 同时重置SVG位置到左上角
                svgContainer.scrollLeft = 0;
                svgContainer.scrollTop = 0;
            });

            // 阻止双指缩放时的页面滚动
            document.addEventListener('touchmove', (e) => {
                if (e.touches.length > 1) {
                    e.preventDefault();
                }
            }, { passive: false });
        }

        // 计算两点之间的距离
        function getDistance(touch1, touch2) {
            const dx = touch1.clientX - touch2.clientX;
            const dy = touch1.clientY - touch2.clientY;
            return Math.sqrt(dx * dx + dy * dy);
        }

        // 应用缩放变换
        function applyTransform() {
            const svgWrapper = document.getElementById('svgWrapper');
            if (svgWrapper) {
                svgWrapper.style.transform = `scale(${scale})`;
            }
        }

        // 步骤1：加载所有线路的JSON数据
        async function loadAllLineData() {
            try {
                for (const fileName of lineJsonFiles) {
                    const response = await fetch(fileName);
                    if (!response.ok) throw new Error(`加载${fileName}失败`);
                    const lineData = await response.json();
                    // 合并到全局数据（取JSON的根键作为线路ID）
                    const lineId = Object.keys(lineData)[0];
                    allLineData[lineId] = lineData[lineId];
                }
                console.log("所有线路数据加载完成：", allLineData);
            } catch (err) {
                alert("线路数据加载失败：" + err.message);
            }
        }

        // 步骤2：初始化SVG交互（等待SVG加载完成）
        (function setupSvgHandler(){
            const lineSvgEl = document.getElementById("lineSvg");
            if (!lineSvgEl) {
                console.warn('未找到 `lineSvg` 对象元素，SVG 交互将被禁用。');
                return;
            }

            lineSvgEl.addEventListener("load", async function() {
                // 先加载所有线路数据
                await loadAllLineData();
                const svgDoc = this.contentDocument; // 获取SVG文档对象
                if (!svgDoc) {
                    console.warn('SVG 的 contentDocument 未能获取，可能被浏览器或安全策略阻止。');
                    return;
                }

                const resetBtn = document.getElementById("resetBtn");
                const htmlLegendContainer = document.getElementById('htmlLegendContainer');

                // 将用于高亮/变暗的样式注入到 SVG 文档内（嵌入的 SVG 需要自身的样式规则）
                function injectSvgStyles(svgDoc) {
                    try {
                        const svgRoot = svgDoc.documentElement || svgDoc.querySelector('svg');
                        if (!svgRoot) return;
                        // 创建 <style> 元素并添加到 SVG 根
                        const styleEl = svgDoc.createElementNS('http://www.w3.org/2000/svg', 'style');
                        // 使用简单的 opacity 与 pointer-events 控制以保证兼容性
                        styleEl.textContent = `
                        .dimmed { opacity: 0.2 !important; filter: grayscale(100%) !important; }
                        .highlighted { opacity: 1 !important; filter: none !important; }
                        `;
                        svgRoot.appendChild(styleEl);
                        console.log('已向嵌入 SVG 注入高亮样式。');
                    } catch (e) {
                        console.warn('注入 SVG 样式失败：', e);
                    }
                }

                // 注入样式，确保 SVG 内的 .dimmed/.highlighted 能生效
                try { injectSvgStyles(svgDoc); } catch(e) { console.warn('注入样式时出错：', e); }

                // 绑定图例的点击事件
                function bindLegendClick() {
                    // 遍历所有线路的图例ID
                    const attempts = [];
                    Object.entries(allLineData).forEach(([lineId, line]) => {
                        const legendId = (line.legend && line.legend[0]) || null;
                        if (!legendId) return;
                        attempts.push(legendId);

                        // 尝试在SVG中查找图例元素（支持部分 id 匹配或文字匹配）
                        const legendEl = findSvgElement(svgDoc, legendId);
                        if (!legendEl) {
                            console.warn('未在SVG中找到图例元素，跳过（会在页面侧边生成后备图例）：', legendId);
                            return;
                        }

                        // 给图例添加点击事件（做好空值检查），并记录绑定信息
                        try {
                            legendEl.addEventListener("click", () => {
                                console.log('SVG 内图例被点击：', legendId);
                                highlightLine(line);
                            });
                            if (legendEl.style) legendEl.style.cursor = "pointer";
                            console.log('已绑定 SVG 图例：', legendId);
                        } catch (e) {
                            console.warn('绑定图例事件失败：', e, legendId);
                        }

                        // 额外：为该线路的 terminalMarks 添加点击绑定（支持多个终点标识）
                        if (Array.isArray(line.terminalMarks)) {
                            line.terminalMarks.forEach(tid => {
                                if (!tid) return;
                                const tEl = findSvgElement(svgDoc, tid) || svgDoc.getElementById(tid);
                                if (!tEl) {
                                    console.warn('未在SVG中找到 terminalMark 元素（跳过）：', tid);
                                    return;
                                }
                                try {
                                    tEl.addEventListener('click', () => {
                                        console.log('SVG 终点标记被点击：', tid, '-> 线路', lineId);
                                        highlightLine(line);
                                    });
                                    if (tEl.style) tEl.style.cursor = 'pointer';
                                    console.log('已绑定 SVG 终点标记：', tid);
                                } catch (err) {
                                    console.warn('绑定 terminalMark 事件失败：', err, tid);
                                }
                            });
                        }
                    });
                    console.info('尝试绑定的图例 id 列表：', attempts);
                }

                // 生成页面侧边的 HTML legend 作为后备（总会生成），并绑定点击事件到 highlightLine
                function createHtmlLegend() {
                    if (!htmlLegendContainer) return;
                    htmlLegendContainer.innerHTML = '';
                    Object.entries(allLineData).forEach(([lineId, line]) => {
                        const legendId = (line.legend && line.legend[0]) || lineId;
                        const entry = document.createElement('button');
                        entry.type = 'button';
                        entry.className = 'html-legend-entry';
                        entry.textContent = lineId;
                        entry.title = legendId;
                        entry.addEventListener('click', () => {
                            console.log('HTML legend 点击：', lineId, legendId);
                            // 激活样式，仅高亮当前 HTML legend
                            const others = htmlLegendContainer.querySelectorAll('.html-legend-entry');
                            others.forEach(o => o.classList.remove('active'));
                            entry.classList.add('active');
                            highlightLine(line);
                        });
                        htmlLegendContainer.appendChild(entry);
                    });
                }

                // 在SVG中查找元素的健壮方法：先按 id 精确查找，再尝试部分匹配 id、最后按显示文字匹配
                function findSvgElement(svgDoc, idOrLabel) {
                    if (!svgDoc || !idOrLabel) return null;

                    // 1) 精确 id
                    try { const exact = svgDoc.getElementById(idOrLabel); if (exact) return exact; } catch(e) {}

                    // 2) 部分匹配 id（包含）
                    try {
                        const partial = svgDoc.querySelector(`[id*="${CSS.escape ? CSS.escape(idOrLabel) : idOrLabel}"]`);
                        if (partial) return partial;
                    } catch(e) { /* ignore */ }

                    // 3) 在所有带 id 的元素里查找包含子串的 id（兼容不支持 CSS.escape 的环境）
                    try {
                        const els = svgDoc.querySelectorAll('[id]');
                        for (let i=0;i<els.length;i++){
                            const el = els[i];
                            if (el.id && el.id.indexOf(idOrLabel) !== -1) return el;
                        }
                    } catch(e){}

                    // 4) 按文本内容查找（去下划线/空格比较）
                    try {
                        const normalize = s => (s || '').toString().trim().replace(/[_\s]+/g, '').toLowerCase();
                        const target = normalize(idOrLabel);
                        const textEls = svgDoc.querySelectorAll('text, tspan');
                        for (let i=0;i<textEls.length;i++){
                            const t = textEls[i];
                            if (normalize(t.textContent) === target) return t;
                        }
                    } catch(e){}

                    return null;
                }

                // 高亮指定线路的所有元素
                function highlightLine(targetLine) {
                    // 1. 先将所有元素设为"变暗"状态（除Information层）
                    dimAllElements(svgDoc);

                    // 2. 收集当前线路的所有关联元素ID
                    const highlightIds = [
                        ...targetLine.lines,
                        ...targetLine.legend,
                        ...targetLine.terminalMarks,
                        ...targetLine.stationMarks,
                        ...targetLine.stationNames
                    ];

                    // 3. 将这些元素设为"高亮"状态
                    highlightIds.forEach(id => {
                        if (!id) return;
                        let el = null;
                        try { el = svgDoc.getElementById(id); } catch(e) { el = null; }
                        if (!el) el = findSvgElement(svgDoc, id);
                        if (el) { // 先判断元素是否存在
                            try { el.classList.remove("dimmed"); } catch(e) { /* ignore */ }
                        } else {
                            console.warn(`未找到元素：${id}`); // 控制台提示缺失的元素ID
                        }
                    });
                }

                // 变暗所有元素（除Information层）
                function dimAllElements(svgDoc) {
                    // 遍历所有线路的元素，统一设为变暗
                    Object.values(allLineData).forEach(line => {
                        const allIds = [
                            ...line.lines,
                            ...line.legend,
                            ...line.terminalMarks,
                            ...line.stationMarks,
                            ...line.stationNames
                        ];
                        allIds.forEach(id => {
                            const el = svgDoc.getElementById(id);
                            if (el) el.classList.add("dimmed");
                        });
                    });
                    // 排除Information层（保持常显）
                    const infoLayer = svgDoc.getElementById("Information");
                    if (infoLayer) {
                        const infoEls = infoLayer.querySelectorAll("*");
                        infoEls.forEach(el => el.classList.remove("dimmed"));
                    }
                }

                // 重置所有元素为默认显示
                resetBtn.addEventListener("click", () => {
                    if (!resetBtn) {
                        console.warn('未找到 `resetBtn`，无法绑定重置操作。');
                        return;
                    }

                    const allEls = svgDoc.querySelectorAll(".dimmed");
                    allEls.forEach(el => { try { el.classList.remove("dimmed"); } catch(e){} });
                });

                // 模态框初始化（在页面级别进行，不依赖 SVG 加载）
                // 初始化：绑定图例事件
                try { bindLegendClick(); } catch(e) { console.warn('绑定图例时出错：', e); }
                try { createHtmlLegend(); } catch(e) { console.warn('生成 HTML 图例时出错：', e); }
            });
        })();

        // 全局模态框初始化（不依赖 SVG 加载）
        (function modalSetup(){
            const titleModalBtn = document.getElementById('titleModalBtn');
            const imageModal = document.getElementById('imageModal');
            const modalClose = imageModal && imageModal.querySelector('.modal-close');

            function openModal() {
                if (!imageModal) return;
                imageModal.classList.add('open');
                imageModal.setAttribute('aria-hidden', 'false');
                document.addEventListener('keydown', escHandler);
            }
            function closeModal() {
                if (!imageModal) return;
                imageModal.classList.remove('open');
                imageModal.setAttribute('aria-hidden', 'true');
                document.removeEventListener('keydown', escHandler);
            }
            function escHandler(e) { if (e.key === 'Escape') closeModal(); }

            if (titleModalBtn) titleModalBtn.addEventListener('click', openModal);
            if (modalClose) modalClose.addEventListener('click', closeModal);
            if (imageModal) {
                imageModal.addEventListener('click', (ev) => {
                    if (ev.target === imageModal || ev.target.hasAttribute('data-close')) closeModal();
                });
            }
        })();

        // 初始化缩放功能
        document.addEventListener('DOMContentLoaded', initZoom);
    </script>
</body>
</html>
