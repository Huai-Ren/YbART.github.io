<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>25121904</title>
    <style>
        :root { --nav-height: 64px; --footer-height: var(--nav-height); }
        /* Reset */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; width: 100%; touch-action: none; }

        /* 顶部固定导航栏 */
        #topNav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--nav-height);
            background: transparent;
            display: flex;
            align-items: center;
            padding: 0 16px;
            z-index: 1000;
            border-bottom: none;
            touch-action: none;
        }
        #topNav::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 95%;
            border-bottom: 1px solid #ccc;
            pointer-events: none;
        }
        #topNav .nav-left, #topNav .nav-center, #topNav .nav-right {
            display: flex;
            align-items: center;
        }
        #topNav .nav-left { flex: 0 0 auto; }
        #topNav .nav-center { flex: 1; justify-content: center; }
        .nav-icon-btn {
            width: 36px; height: 36px; border-radius: 6px; display: inline-flex; align-items: center; justify-content: center;
            background: #fff; border: 1px solid #ccc; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            padding: 6px;
        }
        .nav-icon-img { width: 18px; height: 18px; display: block; }
        #topNav .nav-right { flex: 0 0 auto; }
        #topNav .nav-logo { height: 40px; width: auto; display: block; }
        #topNav .nav-title { height: 44px; max-width: 100%; width: auto; display: block; }

        /* SVG 容器：恢复滚动 + 优化触摸 */
        #svgContainer {
            position: relative;
            width: 100%;
            height: calc(100vh - var(--nav-height) - var(--footer-height));
            top: var(--nav-height);
            overflow: auto; /* 恢复滚动 */
            background: #ffffff;
            z-index: 1;
            touch-action: pan-x pan-y; /* 允许原生滚动 */
            cursor: grab;
        }
        #svgWrapper {
            position: relative;
            transform-origin: 0 0;
            width: auto;
            min-width: 100%;
            height: 100%;
        }
        #lineSvg {
            width: auto; 
            height: 100%; 
            display: block; 
            min-width: 100%;
            transform-origin: 0 0;
            pointer-events: auto;
            touch-action: none;
        }

        /* 重置按钮样式 */
        #resetBtn {
            padding: 6px 12px;
            background-color: #409eff;
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            transform-origin: center center;
        }
        #resetBtn:hover { background-color: #66b1ff; }

        /* 底部固定页脚 */
        #pageFooter {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            height: var(--footer-height);
            background: transparent;
            display: flex;
            align-items: center;
            padding: 0 16px;
            z-index: 1000;
            border-top: none;
            touch-action: none;
        }
        #pageFooter::before {
            content: "";
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 95%;
            border-top: 1px solid #ccc;
            pointer-events: none;
        }
        #pageFooter .footer-left, #pageFooter .footer-center, #pageFooter .footer-right {
            display: flex;
            align-items: center;
        }
        #pageFooter .footer-left { flex: 0 0 240px; display:flex; align-items:center; justify-content:center; }
        .footer-copy { font-size: 12px; color: #333; }
        #pageFooter .footer-center { flex: 1; justify-content: center; }
        #pageFooter .footer-right { flex: 0 0 auto; }

        /* SVG 内的变暗/高亮类 */
        .dimmed { opacity: 0.2; filter: grayscale(100%); transition: opacity .25s ease; }
        .highlighted { opacity: 1; filter: none; }

        /* 页面侧边 HTML legend */
        .html-legend-entry { padding:6px 10px; border:1px solid #d9d9d9; border-radius:4px; background:#fff; cursor:pointer; margin-right:6px; }
        .html-legend-entry.active { background:#409eff; color:#fff; border-color:#409eff; }

        /* 模态框样式 */
        .modal { position: fixed; inset: 0; z-index: 2000; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 220ms ease; }
        .modal.open { opacity: 1; pointer-events: auto; }
        .modal-backdrop { position: absolute; inset: 0; background: rgba(0,0,0,0); transition: background 220ms ease; }
        .modal.open .modal-backdrop { background: rgba(0,0,0,0.5); }
        .modal-content { position: relative; z-index: 2001; background: #fff; border-radius: 8px; padding: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.25); max-width: 92%; max-height: calc(100vh - var(--nav-height) - var(--footer-height) - 40px); display: flex; align-items: center; justify-content: center; transform: translateY(-8px) scale(.98); opacity: 0; transition: transform 220ms cubic-bezier(.2,.9,.2,1), opacity 200ms ease; }
        .modal.open .modal-content { transform: translateY(0) scale(1); opacity: 1; }
        .modal-body img { max-width: 100%; max-height: 100%; display:block; }
        .modal-close { position: absolute; top: 8px; right: 8px; background: transparent; border: none; font-size: 20px; cursor: pointer; }
    </style>
</head>
<body>
    <!-- 顶部固定导航栏 -->
    <nav id="topNav" role="navigation" aria-label="主导航">
        <div class="nav-left">
            <img src="logo.png" alt="Logo" class="nav-logo" />
        </div>
        <div class="nav-center">
            <img src="mainTitle.png" alt="主标题" class="nav-title" />
        </div>
        <div class="nav-right">
            <button id="titleModalBtn" class="nav-icon-btn" aria-haspopup="dialog" aria-controls="imageModal" title="查看 artTime">
                <img src="time.svg" alt="time" class="nav-icon-img" />
            </button>
        </div>
    </nav>

    <!-- 页脚（固定在底部），重置按钮移至右侧 -->
    <footer id="pageFooter" role="contentinfo">
        <div class="footer-left"><small class="footer-copy">Copyright © Leshan HuaiRen Cyber Tech</small></div>
        <div class="footer-center"><!-- 中间预留 --></div>
        <div class="footer-right">
            <button id="resetBtn">重置</button>
        </div>
    </footer>

    <!-- 图片模态框（默认隐藏） -->
    <div id="imageModal" class="modal" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="imageModalTitle">
        <div class="modal-backdrop" data-close></div>
        <div class="modal-content">
            <button class="modal-close" aria-label="关闭">×</button>
            <h2 id="imageModalTitle" style="position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden;">Art Time</h2>
            <div class="modal-body">
                <img src="artTime.jpg" alt="Art Time" />
            </div>
        </div>
    </div>

    <!-- SVG 容器（占满全屏） -->
    <div id="svgContainer">
        <div id="svgWrapper">
            <object id="lineSvg" data="art25121903.svg" type="image/svg+xml"></object>
        </div>
    </div>

    <script>
        // 全局变量
        let allLineData = {};
        let currentScale = 1; // 缩放比例
        let isTwoFinger = false; // 是否双指操作
        let startScale = 1;
        let startDistance = 0;
        
        // 线路JSON文件列表
        const lineJsonFiles = [
            "T1_Branch.json",
            "T1_Extension.json",
            "T1T4_Integrated.json",
            "T2_Branch.json",
            "T2_Main.json",
            "T4_Branch.json"
        ];

        // 加载线路数据
        async function loadAllLineData() {
            try {
                for (const fileName of lineJsonFiles) {
                    const response = await fetch(fileName);
                    if (!response.ok) throw new Error(`加载${fileName}失败`);
                    const lineData = await response.json();
                    const lineId = Object.keys(lineData)[0];
                    allLineData[lineId] = lineData[lineId];
                }
                console.log("所有线路数据加载完成：", allLineData);
            } catch (err) {
                alert("线路数据加载失败：" + err.message);
            }
        }

        // 计算两点距离
        function getDistance(touch1, touch2) {
            const dx = touch2.clientX - touch1.clientX;
            const dy = touch2.clientY - touch1.clientY;
            return Math.sqrt(dx * dx + dy * dy);
        }

        // 更新缩放
        function updateScale(newScale) {
            // 限制缩放范围 0.5-3倍
            currentScale = Math.max(0.5, Math.min(3, newScale));
            const svgWrapper = document.getElementById('svgWrapper');
            svgWrapper.style.transform = `scale(${currentScale})`;
            
            // 缩放后自动调整滚动位置，保持视觉中心
            const container = document.getElementById('svgContainer');
            const rect = svgWrapper.getBoundingClientRect();
            if (rect.width > container.clientWidth) {
                container.scrollLeft = (rect.width - container.clientWidth) / 2;
            }
            if (rect.height > container.clientHeight) {
                container.scrollTop = (rect.height - container.clientHeight) / 2;
            }
        }

        // 初始化触摸缩放
        function initZoom() {
            const container = document.getElementById('svgContainer');
            const svgWrapper = document.getElementById('svgWrapper');

            // 触摸开始
            container.addEventListener('touchstart', (e) => {
                if (e.touches.length === 2) {
                    isTwoFinger = true;
                    startDistance = getDistance(e.touches[0], e.touches[1]);
                    startScale = currentScale;
                    e.preventDefault(); // 双指时阻止默认滚动
                } else {
                    isTwoFinger = false;
                }
            }, { passive: false });

            // 触摸移动
            container.addEventListener('touchmove', (e) => {
                if (isTwoFinger && e.touches.length === 2) {
                    const newDistance = getDistance(e.touches[0], e.touches[1]);
                    const scaleRatio = newDistance / startDistance;
                    const newScale = startScale * scaleRatio;
                    updateScale(newScale);
                    e.preventDefault();
                }
                // 单指时不阻止，保留原生滚动
            }, { passive: false });

            // 触摸结束
            container.addEventListener('touchend', () => {
                isTwoFinger = false;
            });

            // 鼠标滚轮缩放（桌面端）
            container.addEventListener('wheel', (e) => {
                e.preventDefault();
                const delta = e.deltaY > 0 ? -0.1 : 0.1;
                updateScale(currentScale + delta);
            }, { passive: false });

            // 重置按钮
            document.getElementById('resetBtn').addEventListener('click', () => {
                currentScale = 1;
                svgWrapper.style.transform = 'scale(1)';
                // 重置滚动位置
                container.scrollLeft = 0;
                container.scrollTop = 0;
                
                // 重置SVG元素显示状态
                const svgDoc = document.getElementById('lineSvg').contentDocument;
                if (svgDoc) {
                    const allEls = svgDoc.querySelectorAll(".dimmed");
                    allEls.forEach(el => { 
                        try { el.classList.remove("dimmed"); } catch(e){} 
                    });
                }
            });

            // 初始化缩放为1
            updateScale(1);
        }

        // 初始化SVG交互
        (function setupSvgHandler(){
            const lineSvgEl = document.getElementById("lineSvg");
            if (!lineSvgEl) {
                console.warn('未找到 `lineSvg` 对象元素，SVG 交互将被禁用。');
                return;
            }

            lineSvgEl.addEventListener("load", async function() {
                await loadAllLineData();
                const svgDoc = this.contentDocument;
                if (!svgDoc) return;

                // 注入SVG样式
                function injectSvgStyles() {
                    try {
                        const styleEl = svgDoc.createElementNS('http://www.w3.org/2000/svg', 'style');
                        styleEl.textContent = `
                        .dimmed { opacity: 0.2 !important; filter: grayscale(100%) !important; }
                        .highlighted { opacity: 1 !important; filter: none !important; }
                        `;
                        svgDoc.documentElement.appendChild(styleEl);
                    } catch (e) {
                        console.warn('注入 SVG 样式失败：', e);
                    }
                }

                // 查找SVG元素
                function findSvgElement(idOrLabel) {
                    if (!idOrLabel) return null;
                    // 精确ID
                    let el = svgDoc.getElementById(idOrLabel);
                    if (el) return el;
                    // 部分匹配ID
                    el = svgDoc.querySelector(`[id*="${idOrLabel}"]`);
                    if (el) return el;
                    // 文本匹配
                    const textEls = svgDoc.querySelectorAll('text, tspan');
                    for (let i=0; i<textEls.length; i++) {
                        if (textEls[i].textContent.includes(idOrLabel)) return textEls[i];
                    }
                    return null;
                }

                // 高亮线路
                function highlightLine(targetLine) {
                    // 变暗所有元素
                    Object.values(allLineData).forEach(line => {
                        [].concat(line.lines, line.legend, line.terminalMarks, line.stationMarks, line.stationNames)
                           .forEach(id => {
                               const el = findSvgElement(id);
                               if (el) el.classList.add("dimmed");
                           });
                    });
                    // 高亮目标线路
                    [].concat(targetLine.lines, targetLine.legend, targetLine.terminalMarks, targetLine.stationMarks, targetLine.stationNames)
                       .forEach(id => {
                           const el = findSvgElement(id);
                           if (el) el.classList.remove("dimmed");
                       });
                    // 保留Information层
                    const infoLayer = svgDoc.getElementById("Information");
                    if (infoLayer) {
                        infoLayer.querySelectorAll("*").forEach(el => el.classList.remove("dimmed"));
                    }
                }

                // 绑定图例点击
                function bindLegendEvents() {
                    Object.entries(allLineData).forEach(([lineId, line]) => {
                        // 绑定图例
                        const legendId = line.legend?.[0];
                        if (legendId) {
                            const legendEl = findSvgElement(legendId);
                            if (legendEl) {
                                legendEl.style.cursor = "pointer";
                                legendEl.addEventListener("click", () => highlightLine(line));
                            }
                        }
                        // 绑定终点标记
                        (line.terminalMarks || []).forEach(tid => {
                            const tEl = findSvgElement(tid);
                            if (tEl) {
                                tEl.style.cursor = "pointer";
                                tEl.addEventListener("click", () => highlightLine(line));
                            }
                        });
                    });
                }

                // 执行初始化
                injectSvgStyles();
                bindLegendEvents();
            });
        })();

        // 初始化模态框
        (function modalSetup(){
            const modal = document.getElementById('imageModal');
            const openBtn = document.getElementById('titleModalBtn');
            const closeBtn = modal?.querySelector('.modal-close');
            const backdrop = modal?.querySelector('.modal-backdrop');

            if (!modal || !openBtn) return;

            openBtn.addEventListener('click', () => {
                modal.classList.add('open');
                modal.setAttribute('aria-hidden', 'false');
                document.addEventListener('keydown', escClose);
            });

            function closeModal() {
                modal.classList.remove('open');
                modal.setAttribute('aria-hidden', 'true');
                document.removeEventListener('keydown', escClose);
            }

            function escClose(e) {
                if (e.key === 'Escape') closeModal();
            }

            closeBtn?.addEventListener('click', closeModal);
            backdrop?.addEventListener('click', closeModal);
        })();

        // 页面加载完成初始化
        document.addEventListener('DOMContentLoaded', () => {
            initZoom();
        });
    </script>
</body>
</html>
